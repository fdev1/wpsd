DESTDIR=
INSTALL=@INSTALL@
prefix=@prefix@
ICONS_DIR=@datarootdir@/icons
SYSCONFDIR=@sysconfdir@

CC=@CC@
CFLAGS += @CFLAGS@ @DEFS@
CFLAGS += -Wall -DSYSCONFDIR=\"@sysconfdir@\"
EXECUTABLE = wps
DAEMON = wpsd
WPSAPI_PROVIDER = libwpsapi_provider.so
SOURCES = wpsd.c wps.c utils.c logger.c wpsapi.c
OBJECTS = $(SOURCES:.c=.o)

all: $(SOURCES) $(EXECUTABLE) $(DAEMON) $(WPSAPI_PROVIDER)

$(EXECUTABLE): $(OBJECTS)
	$(CC) -o $@ wps.o

$(DAEMON): $(OBJECTS)
	$(CC) -ldl -o $@ wpsd.o utils.o logger.o
	sed -e "s|@PREFIX@|$(prefix)|g" wpsd.service.in > wpsd.service

$(WPSAPI_PROVIDER): $(OBJECTS)
	$(CC) -shared -ldl -o $@ wpsapi.o logger.o

.c.o:
	$(CC) -fPIC $(CFLAGS) -c $< -o $@

clean:
	rm -f $(OBJECTS) $(EXECUTABLE) $(DAEMON) $(WPSAPI_PROVIDER)
	rm -f wpsd.service

mrproper: clean
	rm -f configure
	rm -fr autom4te.cache
	rm -f config.log
	rm -f config.status

install:
	$(INSTALL) -d $(DESTDIR)/$(prefix)/bin
	$(INSTALL) -d $(DESTDIR)/usr/lib/systemd/system
	$(INSTALL) -d $(DESTDIR)/$(SYSCONFDIR)
	$(INSTALL) -d $(DESTDIR)/usr/lib/wpsd/providers/lib
	$(INSTALL) $(EXECUTABLE) $(DESTDIR)/$(prefix)/bin
	$(INSTALL) $(DAEMON) $(DESTDIR)/$(prefix)/bin
	$(INSTALL) $(WPSAPI_PROVIDER) $(DESTDIR)/usr/lib/wpsd/providers
	$(INSTALL) wpsapi/lib/libwpsapi-fedora.so $(DESTDIR)/usr/lib/wpsd/providers/lib
	$(INSTALL) wpsapi/lib/libwpsapi-ubuntu.so $(DESTDIR)/usr/lib/wpsd/providers/lib
	$(INSTALL) wpsd.service $(DESTDIR)/usr/lib/systemd/system
	$(INSTALL) wpsd.conf $(DESTDIR)/$(SYSCONFDIR)

uninstall:
	$(RM) $(DESTDIR)/$(prefix)/bin/$(EXECUTABLE)
	$(RM) $(DESTDIR)/$(prefix)/bin/$(DAEMON)
